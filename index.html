<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VP Wordle</title>
  <style>
    :root{
      --bg:#0f1115;
      --tile:#1a1d24;
      --tile-border:#2a2f3a;
      --text:#e7e9ee;
      --muted:#8b90a0;
      --green:#2fbf71;
      --yellow:#f2c94c;
      --grey:#3a3f4b;
      --key:#232734;
      --key-text:#e7e9ee;
      --key-disabled:#151824;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    body{
      margin:0; background:var(--bg); color:var(--text);
      display:flex; flex-direction:column; align-items:center;
      min-height:100vh; padding:18px 12px 28px; gap:14px;
    }
    h1{ margin:6px 0 0; letter-spacing:2px; font-weight:800; }
    .sub{ color:var(--muted); font-size:14px; margin-top:-6px; }

    .board{
      display:grid; grid-template-rows: repeat(6, 1fr);
      gap:8px; margin-top:8px; width:min(92vw, 380px);
    }
    .row{ display:grid; grid-template-columns: repeat(5, 1fr); gap:8px; }
    .tile{
      aspect-ratio:1/1; background:var(--tile);
      border:2px solid var(--tile-border); border-radius:10px;
      display:flex; align-items:center; justify-content:center;
      font-size:28px; font-weight:800; text-transform:uppercase;
      transition:transform .08s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .tile.pop{ transform:scale(1.05); }
    .tile.green{ background:var(--green); border-color:var(--green); color:#0b0d12; }
    .tile.yellow{ background:var(--yellow); border-color:var(--yellow); color:#0b0d12; }
    .tile.grey{ background:var(--grey); border-color:var(--grey); color:#e5e7eb; }

    .status{ min-height:22px; font-size:15px; color:var(--muted); text-align:center; margin-top:2px; }

    .keyboard{
      display:flex; flex-direction:column; gap:8px;
      width:min(96vw, 520px); margin-top:6px;
    }
    .keyrow{ display:flex; gap:6px; justify-content:center; }
    button.key{
      background:var(--key); color:var(--key-text); border:none;
      padding:12px 10px; border-radius:10px; font-weight:700;
      font-size:14px; min-width:34px; cursor:pointer;
      transition:filter .12s ease, transform .05s ease, background .2s ease;
      text-transform:uppercase; user-select:none;
    }
    button.key:active{ transform:translateY(1px); }
    button.key.wide{ min-width:64px; }
    button.key.green{ background:var(--green); color:#0b0d12; }
    button.key.yellow{ background:var(--yellow); color:#0b0d12; }
    button.key.grey{ background:var(--grey); color:#e5e7eb; }
    button.key.disabled{ background:var(--key-disabled); color:#555b6d; cursor:not-allowed; }

    .controls{ display:flex; gap:8px; margin-top:4px; }
    .controls button{
      background:#1f2430; color:var(--text); border:1px solid #2a2f3a;
      border-radius:10px; padding:8px 12px; cursor:pointer; font-weight:700;
    }
    .controls button:hover{ filter:brightness(1.08); }

    .footer{ color:var(--muted); font-size:12px; margin-top:auto; opacity:.9; }
  </style>
</head>
<body>
  <h1>WORDLE</h1>
  <div class="sub">Guess the 5 letter word. You have 6 tries.</div>

  <div id="board" class="board"></div>
  <div id="status" class="status"></div>

  <div class="controls">
    <button id="restartBtn">Restart</button>
  </div>

  <div id="keyboard" class="keyboard"></div>
  <div class="footer">Physical keyboard supported.</div>

<script>
(() => {
  "use strict";

  // -------------------- PRIVATE GAME DATA (NOT EXPOSED) --------------------
  let solutions = [];
  let validGuesses = new Set();

  // Answer is private to this closure and never attached to window.
  let _answer = "";
  const setAnswer = (w) => { _answer = w; };

  // -------------------- DOM --------------------
  const boardEl = document.getElementById("board");
  const statusEl = document.getElementById("status");
  const keyboardEl = document.getElementById("keyboard");
  const restartBtn = document.getElementById("restartBtn");

  // -------------------- STATE --------------------
  let currentRow = 0;
  let currentCol = 0;
  let isGameOver = false;
  const guesses = Array.from({ length: 6 }, () => Array(5).fill(""));
  const keyState = {}; // unknown | grey | yellow | green

  // -------------------- HELPERS --------------------
  function setStatus(msg, solid=false) {
    statusEl.textContent = msg;
    statusEl.style.color = solid ? "var(--text)" : "var(--muted)";
  }

  async function loadWordLists() {
    try {
      const base = window.location.href;

      const solURL = new URL("solutions.txt", base);
      const guessURL = new URL("guesses.txt", base);

      // cache busting so GH Pages can't serve old files
      solURL.searchParams.set("v", Date.now());
      guessURL.searchParams.set("v", Date.now());

      const [solRes, guessRes] = await Promise.all([
        fetch(solURL),
        fetch(guessURL)
      ]);

      if (!solRes.ok) throw new Error("solutions.txt not reachable");
      if (!guessRes.ok) throw new Error("guesses.txt not reachable");

      const solText = await solRes.text();
      const guessText = await guessRes.text();

      solutions = solText
        .split(/\r?\n/)
        .map(w => w.trim().toLowerCase())
        .filter(w => w.length === 5);

      const guessesArr = guessText
        .split(/\r?\n/)
        .map(w => w.trim().toLowerCase())
        .filter(w => w.length === 5);

      validGuesses = new Set([...solutions, ...guessesArr]);

      setStatus(""); // clear loading message
    } catch (err) {
      setStatus(
        "Word lists failed to load. Check solutions.txt and guesses.txt are reachable.",
        true
      );
      throw err;
    }
  }

  function getDailyIndex() {
    const start = new Date("2021-06-19T00:00:00Z");
    const now = new Date();
    const utcToday = new Date(Date.UTC(
      now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()
    ));
    return Math.floor((utcToday - start) / (1000*60*60*24));
  }

  function getAnswerFromURL() {
    const params = new URLSearchParams(window.location.search);
    const w = (params.get("word") || "").toLowerCase();
    if (w && w.length === 5) return w;
    return null;
  }

  function pickAnswer() {
    const forced = getAnswerFromURL();
    if (forced && validGuesses.has(forced)) {
      setAnswer(forced);
      return;
    }
    const idx = getDailyIndex() % solutions.length;
    setAnswer(solutions[idx]);
  }

  // -------------------- PERSISTENCE (LOCALSTORAGE) --------------------
  function getPuzzleId() {
    return getDailyIndex(); // ties save to today's daily puzzle
  }

  function saveState() {
    const state = {
      puzzleId: getPuzzleId(),
      guesses,
      currentRow,
      currentCol,
      isGameOver,
      keyState
    };
    localStorage.setItem("vpwordle_state", JSON.stringify(state));
  }

  function loadState() {
    const raw = localStorage.getItem("vpwordle_state");
    if (!raw) return false;

    try {
      const state = JSON.parse(raw);

      if (state.puzzleId !== getPuzzleId()) {
        localStorage.removeItem("vpwordle_state");
        return false;
      }

      for (let r = 0; r < 6; r++) {
        for (let c = 0; c < 5; c++) {
          guesses[r][c] = state.guesses?.[r]?.[c] || "";
        }
      }

      currentRow = state.currentRow || 0;
      currentCol = state.currentCol || 0;
      isGameOver = !!state.isGameOver;

      for (const k in keyState) delete keyState[k];
      Object.assign(keyState, state.keyState || {});

      return true;
    } catch {
      return false;
    }
  }

  function hasStartedGame() {
    return guesses.some(row => row.some(ch => ch));
  }

  function updateRestartLock() {
    if (hasStartedGame()) {
      restartBtn.disabled = true;
      restartBtn.style.opacity = "0.6";
      restartBtn.style.cursor = "not-allowed";
      restartBtn.title = "You can't restart today's puzzle.";
    } else {
      restartBtn.disabled = false;
      restartBtn.style.opacity = "1";
      restartBtn.style.cursor = "pointer";
      restartBtn.title = "";
    }
  }

  // -------------------- UI BUILD --------------------
  function buildBoard() {
    boardEl.innerHTML = "";
    for (let r = 0; r < 6; r++) {
      const row = document.createElement("div");
      row.className = "row";
      for (let c = 0; c < 5; c++) {
        const tile = document.createElement("div");
        tile.className = "tile";
        tile.id = `tile-${r}-${c}`;
        row.appendChild(tile);
      }
      boardEl.appendChild(row);
    }
  }

  const KEY_LAYOUT = [
    ["q","w","e","r","t","y","u","i","o","p"],
    ["a","s","d","f","g","h","j","k","l"],
    ["enter","z","x","c","v","b","n","m","backspace"]
  ];

  function buildKeyboard() {
    keyboardEl.innerHTML = "";
    KEY_LAYOUT.forEach(rowKeys => {
      const row = document.createElement("div");
      row.className = "keyrow";
      rowKeys.forEach(k => {
        const btn = document.createElement("button");
        btn.className = "key";
        btn.dataset.key = k;
        btn.textContent = k === "backspace" ? "âŒ«" : k;
        if (k === "enter" || k === "backspace") btn.classList.add("wide");
        btn.onclick = () => handleKey(k);
        row.appendChild(btn);
      });
      keyboardEl.appendChild(row);
    });
  }

  function updateTile(r, c, letter) {
    const tile = document.getElementById(`tile-${r}-${c}`);
    tile.textContent = letter;
    if (letter) {
      tile.classList.add("pop");
      setTimeout(() => tile.classList.remove("pop"), 90);
    }
  }

  function paintRow(r, colours) {
    for (let c = 0; c < 5; c++) {
      document.getElementById(`tile-${r}-${c}`).classList.add(colours[c]);
    }
  }

  function upgradeKeyState(letter, newState) {
    const rank = { unknown:0, grey:1, yellow:2, green:3 };
    const old = keyState[letter] || "unknown";
    if (rank[newState] > rank[old]) keyState[letter] = newState;
  }

  function repaintKeyboard() {
    document.querySelectorAll("button.key").forEach(btn => {
      const k = btn.dataset.key;
      btn.classList.remove("green", "yellow", "grey", "disabled");
      if (k.length === 1) {
        const st = keyState[k] || "unknown";
        if (st !== "unknown") btn.classList.add(st);
        if (st === "grey") btn.classList.add("disabled");
      }
    });
  }

  // -------------------- SCORING (USES PRIVATE _answer) --------------------
  function scoreGuess(guess) {
    const answer = _answer; // private
    const result = Array(5).fill("grey");
    const a = answer.split("");
    const g = guess.split("");

    // greens
    for (let i = 0; i < 5; i++) {
      if (g[i] === a[i]) {
        result[i] = "green";
        a[i] = null;
        g[i] = null;
      }
    }
    // yellows
    for (let i = 0; i < 5; i++) {
      if (g[i] && a.includes(g[i])) {
        result[i] = "yellow";
        a[a.indexOf(g[i])] = null;
      }
    }
    return result;
  }

  // -------------------- INPUT --------------------
  function handleKey(key) {
    if (isGameOver) return;

    if (key === "enter") {
      const guess = guesses[currentRow].join("");
      if (guess.length < 5) return setStatus("Not enough letters.");
      if (!validGuesses.has(guess)) return setStatus("Not in word list.");

      const colours = scoreGuess(guess);
      paintRow(currentRow, colours);

      for (let i = 0; i < 5; i++) {
        upgradeKeyState(guess[i], colours[i]);
      }
      repaintKeyboard();

      // save after a completed guess
      saveState();
      updateRestartLock();

      if (guess === _answer) {
        isGameOver = true;
        saveState();
        updateRestartLock();
        return setStatus(`You got it. The word was ${_answer.toUpperCase()}.`, true);
      }

      currentRow++;
      currentCol = 0;

      if (currentRow === 6) {
        isGameOver = true;
        saveState();
        updateRestartLock();
        return setStatus(`Out of guesses. The word was ${_answer.toUpperCase()}.`, true);
      }

      setStatus("");
      return;
    }

    if (key === "backspace") {
      if (currentCol > 0) {
        currentCol--;
        guesses[currentRow][currentCol] = "";
        updateTile(currentRow, currentCol, "");
      }
      return;
    }

    if (/^[a-z]$/.test(key)) {
      if (currentCol < 5) {
        guesses[currentRow][currentCol] = key;
        updateTile(currentRow, currentCol, key);
        currentCol++;
      }
    }
  }

  window.addEventListener("keydown", (e) => {
    const k = e.key.toLowerCase();
    if (k === "enter" || k === "backspace" || /^[a-z]$/.test(k)) {
      handleKey(k);
    }
  });

  // -------------------- RESET --------------------
  async function resetGame() {
    setStatus("Loading word lists...");
    await loadWordLists();

    if (solutions.length === 0 || validGuesses.size === 0) return;

    // start fresh before restore
    guesses.forEach(r => r.fill(""));
    currentRow = 0;
    currentCol = 0;
    isGameOver = false;
    for (const k in keyState) delete keyState[k];

    // restore if same daily puzzle
    const restored = loadState();

    pickAnswer();
    buildBoard();
    buildKeyboard();

    if (restored) {
      // repaint tiles text and colours for completed rows
      for (let r = 0; r < 6; r++) {
        const guessStr = guesses[r].join("");
        if (!guessStr) continue;

        for (let c = 0; c < 5; c++) {
          updateTile(r, c, guesses[r][c]);
        }

        // only colour rows that were submitted
        if (r < currentRow) {
          const colours = scoreGuess(guessStr);
          paintRow(r, colours);
        }
      }

      repaintKeyboard();

      if (isGameOver) {
        const lastGuess = guesses[currentRow - 1]?.join("") || "";
        if (lastGuess === _answer) {
          setStatus(`You got it. The word was ${_answer.toUpperCase()}.`, true);
        } else {
          setStatus(`Out of guesses. The word was ${_answer.toUpperCase()}.`, true);
        }
      }
    }

    updateRestartLock();
  }

  // Restart only if they haven't started today's puzzle
  restartBtn.onclick = () => {
    if (hasStartedGame()) return;
    resetGame();
  };

  resetGame();
})();
</script>
</body>
</html>
