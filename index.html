<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VP Wordle</title>

  <style>
    :root{
      --bg:#0f1115;
      --tile:#1a1d24;
      --tile-border:#2a2f3a;
      --text:#e7e9ee;
      --muted:#8b90a0;
      --green:#2fbf71;
      --yellow:#f2c94c;
      --grey:#3a3f4b;
      --key:#232734;
      --key-text:#e7e9ee;
      --key-disabled:#151824;
      --panel:#161922;
      --panel-border:#262a36;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    body{
      margin:0; background:var(--bg); color:var(--text);
      display:flex; flex-direction:column; align-items:center;
      min-height:100vh; padding:18px 12px 28px; gap:12px;
    }
    h1{ margin:6px 0 0; letter-spacing:2px; font-weight:800; }
    .sub{ color:var(--muted); font-size:14px; margin-top:-6px; text-align:center; }

    .board{
      display:grid; grid-template-rows: repeat(6, 1fr);
      gap:8px; margin-top:8px; width:min(92vw, 380px);
    }
    .row{ display:grid; grid-template-columns: repeat(5, 1fr); gap:8px; }
    .tile{
      aspect-ratio:1/1; background:var(--tile);
      border:2px solid var(--tile-border); border-radius:10px;
      display:flex; align-items:center; justify-content:center;
      font-size:28px; font-weight:800; text-transform:uppercase;
      transition:transform .08s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .tile.pop{ transform:scale(1.05); }
    .tile.green{ background:var(--green); border-color:var(--green); color:#0b0d12; }
    .tile.yellow{ background:var(--yellow); border-color:var(--yellow); color:#0b0d12; }
    .tile.grey{ background:var(--grey); border-color:var(--grey); color:#e5e7eb; }

    .status{ min-height:22px; font-size:15px; color:var(--muted); text-align:center; margin-top:2px; }

    .keyboard{
      display:flex; flex-direction:column; gap:8px;
      width:min(96vw, 520px); margin-top:6px;
    }
    .keyrow{ display:flex; gap:6px; justify-content:center; }
    button.key{
      background:var(--key); color:var(--key-text); border:none;
      padding:12px 10px; border-radius:10px; font-weight:700;
      font-size:14px; min-width:34px; cursor:pointer;
      transition:filter .12s ease, transform .05s ease, background .2s ease;
      text-transform:uppercase; user-select:none;
    }
    button.key:active{ transform:translateY(1px); }
    button.key.wide{ min-width:64px; }
    button.key.green{ background:var(--green); color:#0b0d12; }
    button.key.yellow{ background:var(--yellow); color:#0b0d12; }
    button.key.grey{ background:var(--grey); color:#e5e7eb; }
    button.key.disabled{ background:var(--key-disabled); color:#555b6d; cursor:not-allowed; }

    .footer{ color:var(--muted); font-size:12px; margin-top:auto; opacity:.9; }

    .auth-panel{
      width:min(92vw, 520px);
      background:var(--panel);
      border:1px solid var(--panel-border);
      border-radius:12px;
      padding:10px;
      display:flex; gap:8px;
      align-items:center; justify-content:center;
      margin-top:2px;
    }
    .auth-panel input{
      flex:1; min-width:140px;
      padding:8px 10px; border-radius:8px;
      border:1px solid #333845;
      background:#0f1115; color:var(--text);
    }
    .auth-panel button{
      padding:8px 12px; border-radius:8px; cursor:pointer;
      font-weight:700; border:1px solid #333845;
      background:#1f2430; color:var(--text);
    }

    /* LOADER */
    .vp-loader{
      position:fixed; inset:0;
      background:#0b0d12;
      display:flex; align-items:center; justify-content:center;
      z-index:9999; opacity:1; transition:opacity 700ms ease;
    }
    .vp-loader.hide{ opacity:0; pointer-events:none; }
    .game-wrapper{ opacity:0; transition:opacity 500ms ease; }
    .game-wrapper.show{ opacity:1; }

    .vp-loader-img{
      width:140px; height:140px; border-radius:50%;
      animation:spin 2.6s linear infinite;
    }
    @keyframes spin{ to{transform:rotate(360deg);} }
  </style>
</head>
<body>

  <!-- LOADER -->
  <div id="vpLoader" class="vp-loader">
    <img class="vp-loader-img"
         src="https://github.com/chrisvp5/VPwordle/blob/main/Copy%20of%20Jay%20Recycle%20.png?raw=true" />
  </div>

  <!-- GAME WRAPPER -->
  <div id="gameWrapper" class="game-wrapper">
    <h1>WORDLE</h1>
    <div class="sub">Guess the word in 6 tries.</div>

    <div id="board" class="board"></div>
    <div id="status" class="status"></div>

    <div class="auth-panel" id="authBox">
      <input id="emailInput" type="email" placeholder="Enter email"/>
      <button id="loginBtn">Login</button>
      <button id="logoutBtn" style="display:none;">Logout</button>
    </div>

    <div id="keyboard" class="keyboard"></div>
    <div class="footer">Physical keyboard supported.</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
  (() => {
    "use strict";

    /* ==============================
       1. STATUS DISPLAY
    ============================== */
    function setStatus(msg, solid=false){
      const s=document.getElementById("status");
      s.textContent=msg;
      s.style.color=solid?"var(--text)":"var(--muted)";
    }

    /* ==============================
       2. LOADER
    ============================== */
    const loader=document.getElementById("vpLoader");
    const wrapper=document.getElementById("gameWrapper");

    function hideLoader(){
      loader.classList.add("hide");
      wrapper.classList.add("show");
    }

    /* ==============================
       3. SUPABASE CLIENT
    ============================== */
    const SUPABASE_URL="https://ruenrertnvhyglbwhqpc.supabase.co";
    const SUPABASE_KEY="sb_publishable_3jLPUT8TNCr-gJtrA5rPFg_A11cxx2G";

    const supabase = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_KEY,
      {
        auth:{
          persistSession:true,
          detectSessionInUrl:true,
          autoRefreshToken:true
        }
      }
    );

    const emailInput=document.getElementById("emailInput");
    const loginBtn=document.getElementById("loginBtn");
    const logoutBtn=document.getElementById("logoutBtn");

    async function refreshAuthUI(){
      const {data:{user}} = await supabase.auth.getUser();
      if (user){
        loginBtn.style.display="none";
        emailInput.style.display="none";
        logoutBtn.style.display="inline-block";
        setStatus("Logged in as " + user.email);
      } else {
        loginBtn.style.display="inline-block";
        emailInput.style.display="inline-block";
        logoutBtn.style.display="none";
      }
    }

    loginBtn.onclick=async()=>{
      const email=emailInput.value.trim();
      if(!email) return setStatus("Enter an email");

      const {error}=await supabase.auth.signInWithOtp({
        email,
        options:{
          emailRedirectTo:"https://chrisvp5.github.io/VPwordle/"
        }
      });

      if(error) return setStatus("Error: "+error.message,true);
      setStatus("Magic link sent!");
    };

    logoutBtn.onclick=async()=>{
      await supabase.auth.signOut();
      refreshAuthUI();
      setStatus("Logged out");
    };

    supabase.auth.onAuthStateChange(()=>refreshAuthUI());

    /* ==============================
       4. WORD LIST LOADERS
    ============================== */

    let solutions=[];
    let validGuesses=new Set();
    let _answer="";

    async function loadWordLists(){
      try{
        const base=window.location.href;
        const solURL=new URL("solutions.txt",base);
        const gURL=new URL("guesses.txt",base);
        solURL.searchParams.set("v",Date.now());
        gURL.searchParams.set("v",Date.now());

        const [sRes,gRes]=await Promise.all([
          fetch(solURL), fetch(gURL)
        ]);

        const solText=await sRes.text();
        const guessText=await gRes.text();

        solutions=solText.split("\n").map(w=>w.trim()).filter(w=>w.length===5);
        validGuesses=new Set([
          ...solutions,
          ...guessText.split("\n").map(w=>w.trim()).filter(w=>w.length===5)
        ]);

        if(!solutions.length) throw "Solutions empty";
      }catch(e){
        solutions=["crane","trace","slate","charm","sugar"];
        validGuesses=new Set(solutions);
        setStatus("Failed to load word lists. Using fallback list.",true);
      }
    }

    function getDailyIndex(){
      const start=new Date("2021-06-19T00:00:00Z");
      const now=new Date();
      const utcToday=new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
      return Math.floor((utcToday-start)/86400000);
    }

    function pickAnswer(){
      const idx=getDailyIndex() % solutions.length;
      _answer = solutions[idx];
    }

    /* ==============================
       5. WORDLE GAME
    ============================== */

    const boardEl=document.getElementById("board");
    const keyboardEl=document.getElementById("keyboard");
    const guesses=Array.from({length:6},()=>Array(5).fill(""));
    const keyState={};

    let currentRow=0;
    let currentCol=0;
    let isGameOver=false;

    function buildBoard(){
      boardEl.innerHTML="";
      for(let r=0;r<6;r++){
        const row=document.createElement("div");
        row.className="row";
        for(let c=0;c<5;c++){
          const tile=document.createElement("div");
          tile.className="tile";
          tile.id=`tile-${r}-${c}`;
          row.appendChild(tile);
        }
        boardEl.appendChild(row);
      }
    }

    const KEYS=[
      ["q","w","e","r","t","y","u","i","o","p"],
      ["a","s","d","f","g","h","j","k","l"],
      ["enter","z","x","c","v","b","n","m","backspace"]
    ];

    function buildKeyboard(){
      keyboardEl.innerHTML="";
      KEYS.forEach(row=>{
        const div=document.createElement("div");
        div.className="keyrow";
        row.forEach(k=>{
          const b=document.createElement("button");
          b.className="key";
          b.dataset.key=k;
          b.textContent=(k==="backspace")?"âŒ«":k;
          if(k==="enter"||k==="backspace") b.classList.add("wide");
          b.onclick=()=>handleKey(k);
          div.appendChild(b);
        });
        keyboardEl.appendChild(div);
      });
    }

    function updateTile(r,c,l){
      const t=document.getElementById(`tile-${r}-${c}`);
      t.textContent=l;
      if(l){ t.classList.add("pop"); setTimeout(()=>t.classList.remove("pop"),80); }
    }

    function paintRow(r,col){
      for(let c=0;c<5;c++){
        document.getElementById(`tile-${r}-${c}`).classList.add(col[c]);
      }
    }

    function scoreGuess(guess){
      const a=_answer.split("");
      const g=guess.split("");
      const out=Array(5).fill("grey");

      for(let i=0;i<5;i++){
        if(g[i]===a[i]){
          out[i]="green";
          a[i]=null;
          g[i]=null;
        }
      }
      for(let i=0;i<5;i++){
        if(g[i] && a.includes(g[i])){
          out[i]="yellow";
          a[a.indexOf(g[i])]=null;
        }
      }
      return out;
    }

    function handleKey(k){
      if(isGameOver) return;

      if(k==="enter"){
        const guess=guesses[currentRow].join("");
        if(guess.length<5) return setStatus("Not enough letters");
        if(!validGuesses.has(guess)) return setStatus("Not in word list");

        const col=scoreGuess(guess);
        paintRow(currentRow,col);

        if(guess===_answer){
          isGameOver=true;
          return setStatus(`You got it. ${_answer.toUpperCase()}`,true);
        }

        currentRow++;
        currentCol=0;

        if(currentRow===6){
          isGameOver=true;
          return setStatus(`Out of guesses. ${_answer.toUpperCase()}`,true);
        }

        setStatus("");
        return;
      }

      if(k==="backspace"){
        if(currentCol>0){
          currentCol--;
          guesses[currentRow][currentCol]="";
          updateTile(currentRow,currentCol,"");
        }
        return;
      }

      if(/^[a-z]$/.test(k)){
        if(currentCol<5){
          guesses[currentRow][currentCol]=k;
          updateTile(currentRow,currentCol,k);
          currentCol++;
        }
      }
    }

    window.addEventListener("keydown",e=>{
      if(!e.key) return;
      const k=e.key.toLowerCase();
      if(k==="enter"||k==="backspace"||/^[a-z]$/.test(k)) handleKey(k);
    });

    /* ==============================
       6. MAIN STARTUP FLOW
    ============================== */

    async function startGame(){
      setStatus("Loading words...");
      await loadWordLists();

      pickAnswer();
      buildBoard();
      buildKeyboard();
      setStatus("");
    }

    async function boot(){
      const returning =
        window.location.hash.includes("access_token") ||
        window.location.search.includes("code=");

      if(returning){
        await new Promise(r=>setTimeout(r,400));
        history.replaceState({}, document.title, window.location.pathname);
      }

      await refreshAuthUI();
      await startGame();
      hideLoader();
    }

    window.addEventListener("DOMContentLoaded", boot);
  })();
  </script>
</body>
</html>
