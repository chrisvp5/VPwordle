<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VP Wordle</title>

  <style>
    :root{
      --bg:#0f1115;
      --tile:#1a1d24;
      --tile-border:#2a2f3a;
      --text:#e7e9ee;
      --muted:#8b90a0;
      --green:#2fbf71;
      --yellow:#f2c94c;
      --grey:#3a3f4b;
      --key:#232734;
      --key-text:#e7e9ee;
      --key-disabled:#151824;
      --panel:#161922;
      --panel-border:#262a36;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    body{
      margin:0; background:var(--bg); color:var(--text);
      display:flex; flex-direction:column; align-items:center;
      min-height:100vh; padding:18px 12px 28px; gap:12px;
    }
    h1{ margin:6px 0 0; letter-spacing:2px; font-weight:800; }
    .sub{ color:var(--muted); font-size:14px; margin-top:-6px; text-align:center; }

    .board{
      display:grid; grid-template-rows: repeat(6, 1fr);
      gap:8px; margin-top:8px; width:min(92vw, 380px);
    }
    .row{ display:grid; grid-template-columns: repeat(5, 1fr); gap:8px; }
    .tile{
      aspect-ratio:1/1; background:var(--tile);
      border:2px solid var(--tile-border); border-radius:10px;
      display:flex; align-items:center; justify-content:center;
      font-size:28px; font-weight:800; text-transform:uppercase;
      transition:transform .08s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .tile.pop{ transform:scale(1.05); }
    .tile.green{ background:var(--green); border-color:var(--green); color:#0b0d12; }
    .tile.yellow{ background:var(--yellow); border-color:var(--yellow); color:#0b0d12; }
    .tile.grey{ background:var(--grey); border-color:var(--grey); color:#e5e7eb; }

    .status{ min-height:22px; font-size:15px; color:var(--muted); text-align:center; margin-top:2px; }

    .keyboard{
      display:flex; flex-direction:column; gap:8px;
      width:min(96vw, 520px); margin-top:6px;
    }
    .keyrow{ display:flex; gap:6px; justify-content:center; }
    button.key{
      background:var(--key); color:var(--key-text); border:none;
      padding:12px 10px; border-radius:10px; font-weight:700;
      font-size:14px; min-width:34px; cursor:pointer;
      transition:filter .12s ease, transform .05s ease, background .2s ease;
      text-transform:uppercase; user-select:none;
    }
    button.key:active{ transform:translateY(1px); }
    button.key.wide{ min-width:64px; }
    button.key.green{ background:var(--green); color:#0b0d12; }
    button.key.yellow{ background:var(--yellow); color:#0b0d12; }
    button.key.grey{ background:var(--grey); color:#e5e7eb; }
    button.key.disabled{ background:var(--key-disabled); color:#555b6d; cursor:not-allowed; }

    .footer{ color:var(--muted); font-size:12px; margin-top:auto; opacity:.9; }

    /* Auth panel */
    .auth-panel{
      width:min(92vw, 380px);
      background:var(--panel);
      border:1px solid var(--panel-border);
      border-radius:12px;
      padding:10px;
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      margin-top:2px;
      flex-wrap:wrap;
    }
    .auth-panel input{
      flex:1;
      min-width:150px;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #333845;
      background:#0f1115;
      color:var(--text);
      outline:none;
    }
    .auth-panel button{
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
      border:1px solid #333845;
      background:#1f2430;
      color:var(--text);
    }
    .auth-panel button:hover{ filter:brightness(1.08); }
    .auth-note{
      font-size:12px;
      color:var(--muted);
      text-align:center;
      margin-top:-4px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
    }
    .auth-note button{
      border:none;
      background:none;
      color:var(--muted);
      font-size:11px;
      cursor:pointer;
      text-decoration:underline;
      padding:0;
      opacity:0.85;
    }
    .auth-note button:hover{
      opacity:1;
    }

    /* Auth button states */
    .auth-btn{
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap:8px;
      min-width:120px;
      transition: transform .08s ease, filter .2s ease, opacity .2s ease;
    }
    .auth-btn:hover{ filter:brightness(1.12); }
    .auth-btn:active{ transform: translateY(1px) scale(0.98); }
    .auth-btn.loading{
      opacity:0.85;
      cursor: wait;
      transform: scale(0.98);
    }
    .auth-btn .btn-text{ transition: opacity .15s ease; }
    .auth-btn.loading .btn-text{ opacity:0.75; }
    .spinner{
      width:16px; height:16px; border-radius:50%;
      border:2px solid rgba(255,255,255,0.25);
      border-top-color: rgba(255,255,255,0.9);
      display:none; animation: spin .8s linear infinite;
    }
    .auth-btn.loading .spinner{ display:inline-block; }
    @keyframes spin{ to { transform: rotate(360deg); } }
    .auth-btn.success{ animation: pulse .6s ease; }
    @keyframes pulse{
      0%{ transform:scale(1); }
      50%{ transform:scale(1.06); }
      100%{ transform:scale(1); }
    }

    /* ===== VP LOADER ===== */
    .vp-loader{
      position:fixed; inset:0;
      background: radial-gradient(ellipse at center, #141824 0%, #0b0d12 60%, #05060a 100%);
      display:flex; align-items:center; justify-content:center;
      z-index:9999; opacity:1; transition: opacity 700ms ease;
    }
    .vp-loader.hide{ opacity:0; pointer-events:none; }
    .vp-loader-inner{
      display:flex; flex-direction:column; align-items:center; gap:12px;
      transform: translateY(-10px);
    }
    .vp-loader-img{
      width:140px; height:140px; border-radius:50%; object-fit:cover;
      border:3px solid rgba(255,255,255,0.08);
      box-shadow: 0 0 40px rgba(47,191,113,0.18);
      animation: vpSpin 2.8s linear infinite, vpFloat 1.6s ease-in-out infinite;
    }
    .vp-loader-title{
      font-size:32px; font-weight:900; letter-spacing:3px; text-transform:uppercase;
      background: linear-gradient(90deg, #ffffff, #9ad7ff, #ffffff);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      animation: vpGlow 1.8s ease-in-out infinite;
    }
    .vp-loader-sub{
      font-size:14px; color:#9aa1b2; letter-spacing:1px; text-transform:uppercase;
    }
    .dots span{ display:inline-block; animation: dotBounce 1.1s infinite; }
    .dots span:nth-child(2){ animation-delay: .15s; }
    .dots span:nth-child(3){ animation-delay: .30s; }

    @keyframes vpSpin{ to{ transform: rotate(360deg); } }
    @keyframes vpFloat{ 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-6px); } }
    @keyframes vpGlow{ 0%,100%{ filter:none; } 50%{ filter: drop-shadow(0 0 12px rgba(154,215,255,0.55)); } }
    @keyframes dotBounce{ 0%,100%{ transform: translateY(0); opacity:.4; } 50%{ transform: translateY(-4px); opacity:1; } }

    /* Layout */
    .game-wrapper{
      opacity:0;
      transition: opacity 600ms ease;
      width:100%;
      max-width:980px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:16px;
    }
    .game-wrapper.show{ opacity:1; }

    .game-main{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
    }

    .game-side{
      width:100%;
      max-width:520px;
    }

    @media (min-width: 900px){
      .game-wrapper{
        flex-direction:row;
        align-items:flex-start;
        justify-content:center;
        gap:24px;
      }
      .game-main{
        max-width:380px;
      }
      .game-side{
        max-width:320px;
        margin-top:32px;
      }
    }

    /* SCOREBOARD */
    .scoreboard{
      width:100%;
      background:#141722;
      border:1px solid #262a36;
      border-radius:12px;
      padding:10px 10px 8px;
      font-size:12px;
    }
    .scoreboard-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
      color:var(--muted);
    }
    .scoreboard-title{
      font-weight:700;
      font-size:13px;
      letter-spacing:0.5px;
      text-transform:uppercase;
    }
    .scoreboard-week{
      font-size:11px;
      opacity:0.8;
    }
    .scoreboard table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      font-size:11px;
    }
    .scoreboard th,
    .scoreboard td{
      border-bottom:1px solid #252a37;
      padding:4px 2px;
      text-align:center;
    }
    .scoreboard th:first-child,
    .scoreboard td:first-child{
      text-align:left;
      padding-left:4px;
      font-weight:600;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:150px;
    }
    .scoreboard th{
      color:var(--muted);
      font-weight:600;
    }
    .scoreboard td{
      color:#cfd3e1;
    }
    .score-empty{
      text-align:center;
      font-size:11px;
      color:var(--muted);
      padding:4px 0 2px;
    }
  </style>
</head>
<body>

  <!-- VP Wordle Loading Screen -->
  <div id="vpLoader" class="vp-loader">
    <div class="vp-loader-inner">
      <img
        src="https://github.com/chrisvp5/VPwordle/blob/main/Copy%20of%20Jay%20Recycle%20.png?raw=true"
        alt="VP Loader"
        class="vp-loader-img"
      />
      <div class="vp-loader-title">VP WORDLE</div>
      <div class="vp-loader-sub">
        Loading <span class="dots"><span>.</span><span>.</span><span>.</span></span>
      </div>
    </div>
  </div>

  <div id="gameWrapper" class="game-wrapper">
    <!-- LEFT: MAIN GAME -->
    <div class="game-main">
      <h1>WORDLE</h1>
      <div class="sub">Guess the 5 letter word. You have 6 tries.</div>

      <div id="board" class="board"></div>
      <div id="status" class="status"></div>

      <!-- AUTH PANEL -->
      <div class="auth-panel" id="authBox">
        <input id="emailInput" type="email" placeholder="Email" />
        <input id="passwordInput" type="password" placeholder="Password" />
        <button id="loginBtn" class="auth-btn">
          <span class="btn-text">Login</span>
          <span class="spinner" aria-hidden="true"></span>
        </button>
        <button id="logoutBtn" style="display:none;">Logout</button>
      </div>
      <div class="auth-note">
        <span>Login is optional. If you login, your results are saved.</span>
        <button id="toggleModeBtn">Need an account? Create one</button>
      </div>

      <div id="keyboard" class="keyboard"></div>
      <div class="footer">Physical keyboard supported.</div>
    </div>

    <!-- RIGHT: SCOREBOARD -->
    <div class="game-side">
      <div id="scoreboard" class="scoreboard">
        <div class="scoreboard-header">
          <div class="scoreboard-title">This Week's Scores</div>
          <div id="scoreboardWeekLabel" class="scoreboard-week"></div>
        </div>
        <div id="scoreboardContent" class="scoreboard-content score-empty">
          Loading scoreboard...
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
  (() => {
    "use strict";

    // -------------------- STATUS + ERROR SURFACE --------------------
    const statusEl = document.getElementById("status");
    function setStatus(msg, solid=false){
      if(!statusEl) return;
      statusEl.textContent = msg;
      statusEl.style.color = solid ? "var(--text)" : "var(--muted)";
    }

    window.addEventListener("error", (e) => {
      setStatus("JS error: " + e.message, true);
      console.error(e);
    });
    window.addEventListener("unhandledrejection", (e) => {
      const msg = e.reason?.message || String(e.reason);
      setStatus("Async error: " + msg, true);
      console.error(e);
    });

    // -------------------- LOADER --------------------
    const vpLoader = document.getElementById("vpLoader");
    const gameWrapper = document.getElementById("gameWrapper");
    function hideLoader(){
      if(!vpLoader) return;
      vpLoader.classList.add("hide");
      gameWrapper.classList.add("show");
      setTimeout(()=>vpLoader.remove(), 800);
    }

    // -------------------- SUPABASE INIT --------------------
    const SUPABASE_URL = "https://ruenrertnvhyglbwhqpc.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_3jLPUT8TNCr-gJtrA5rPFg_A11cxx2G";

    const emailInput = document.getElementById("emailInput");
    const passwordInput = document.getElementById("passwordInput");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const authBox = document.getElementById("authBox");
    const toggleModeBtn = document.getElementById("toggleModeBtn");

    const scoreboardContent = document.getElementById("scoreboardContent");
    const scoreboardWeekLabel = document.getElementById("scoreboardWeekLabel");

    // "login" or "signup"
    let authMode = "login";

    let supabase = null;
    if (window.supabase && SUPABASE_URL && SUPABASE_ANON_KEY){
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: true
        }
      });
    } else {
      if (authBox) authBox.style.display = "none";
      console.warn("Supabase not available, running without login.");
    }

    async function refreshAuthUI(){
      if(!supabase) return;
      const { data:{ user } } = await supabase.auth.getUser();
      if(user){
        if (emailInput) {
          emailInput.style.display = "inline-block";
          emailInput.value = user.email || "";
          emailInput.disabled = true;
        }
        if (passwordInput) {
          passwordInput.style.display = "none";
          passwordInput.value = "";
        }
        if (loginBtn) loginBtn.style.display = "none";
        if (logoutBtn) logoutBtn.style.display = "inline-block";
        if (toggleModeBtn) toggleModeBtn.style.display = "none";
        setStatus("Logged in as " + user.email);
      } else {
        if (emailInput) {
          emailInput.style.display = "inline-block";
          emailInput.disabled = false;
        }
        if (passwordInput) {
          passwordInput.style.display = "inline-block";
          passwordInput.value = "";
        }
        if (loginBtn) loginBtn.style.display = "inline-flex";
        if (logoutBtn) logoutBtn.style.display = "none";
        if (toggleModeBtn) toggleModeBtn.style.display = "inline-block";
      }
    }

    // ---- Toggle between Login and Signup modes ----
    if (toggleModeBtn) {
      toggleModeBtn.onclick = () => {
        if (authMode === "login") {
          authMode = "signup";
          toggleModeBtn.textContent = "Already have an account? Login";
          if (loginBtn) {
            const txt = loginBtn.querySelector(".btn-text");
            if (txt) txt.textContent = "Create account";
          }
          setStatus("Enter email and password to create an account.");
        } else {
          authMode = "login";
          toggleModeBtn.textContent = "Need an account? Create one";
          if (loginBtn) {
            const txt = loginBtn.querySelector(".btn-text");
            if (txt) txt.textContent = "Login";
          }
          setStatus("");
        }
      };
    }

    // ---- Login / Signup button ----
    if(loginBtn){
      loginBtn.onclick = async () => {
        if(!supabase) return setStatus("Login not configured yet.");

        const email = (emailInput?.value || "").trim();
        const password = passwordInput?.value || "";

        if(!email || !password){
          return setStatus("Enter email and password.");
        }

        loginBtn.classList.add("loading");
        loginBtn.disabled = true;
        setStatus(authMode === "signup" ? "Creating account..." : "Logging in...");

        try {
          if (authMode === "signup") {
            const { data, error } = await supabase.auth.signUp({
              email,
              password
              // If you use email confirmation with redirect:
              // options: { emailRedirectTo: "https://chrisvp5.github.io/VPwordle/" }
            });

            if (error) {
              setStatus("Signup error: " + error.message, true);
              return;
            }

            if (data.user) {
              await refreshAuthUI();
              setStatus("Account created and logged in as " + data.user.email, true);
              await loadScoreboard();
            } else {
              setStatus("Account created. Check your email to confirm.", true);
            }
          } else {
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });

            if (error) {
              setStatus("Login error: " + error.message, true);
              return;
            }

            await refreshAuthUI();
            setStatus("Logged in as " + (data.user?.email || email), true);
            await loadScoreboard();
          }
        } finally {
          loginBtn.classList.remove("loading");
          loginBtn.disabled = false;
        }
      };
    }

    if (logoutBtn) {
      logoutBtn.onclick = async () => {
        if (!supabase) {
          setStatus("Logout not configured.", true);
          return;
        }

        logoutBtn.disabled = true;
        setStatus("Logging out...");

        try {
          const { error } = await supabase.auth.signOut();

          if (error) {
            console.error("Logout error:", error);
            setStatus("Logout error: " + error.message, true);
            return;
          }

          authMode = "login";

          if (loginBtn) {
            const txt = loginBtn.querySelector(".btn-text");
            if (txt) txt.textContent = "Login";
            loginBtn.style.display = "inline-flex";
          }
          if (emailInput) {
            emailInput.disabled = false;
          }
          if (passwordInput) {
            passwordInput.style.display = "inline-block";
            passwordInput.value = "";
          }
          if (toggleModeBtn) {
            toggleModeBtn.style.display = "inline-block";
            toggleModeBtn.textContent = "Need an account? Create one";
          }
          if (logoutBtn) {
            logoutBtn.style.display = "none";
          }

          await refreshAuthUI();
          setStatus("Logged out.", true);
          await loadScoreboard();
        } finally {
          logoutBtn.disabled = false;
        }
      };
    }

    if(supabase){
      supabase.auth.onAuthStateChange(() => {
        refreshAuthUI();
        loadScoreboard();
      });
    }

    // -------------------- PUZZLE ID HELPERS --------------------
    function getDailyIndex(){
      const start = new Date("2021-06-19T00:00:00Z");
      const now = new Date();
      const utcToday = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
      return Math.floor((utcToday - start) / (1000*60*60*24));
    }
    const getPuzzleId = () => getDailyIndex();

    // Monday-based week in UTC
    function getWeekInfo(){
      const todayId = getDailyIndex();
      const now = new Date();
      const weekdayUTC = now.getUTCDay(); // 0=Sun..6=Sat
      const mondayIndex = (weekdayUTC + 6) % 7; // 0=Mon..6=Sun

      const weekIds = [];
      for (let offset = 0; offset < 7; offset++) {
        weekIds.push(todayId - mondayIndex + offset);
      }

      const todayUTC = new Date(Date.UTC(
        now.getUTCFullYear(),
        now.getUTCMonth(),
        now.getUTCDate()
      ));
      const mondayDate = new Date(todayUTC);
      mondayDate.setUTCDate(mondayDate.getUTCDate() - mondayIndex);
      const sundayDate = new Date(mondayDate);
      sundayDate.setUTCDate(sundayDate.getUTCDate() + 6);

      return { weekIds, mondayDate, sundayDate };
    }

    const WEEKDAY_LABELS = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

    // -------------------- SCOREBOARD --------------------
    async function loadScoreboard(){
      if (!supabase || !scoreboardContent) return;

      const { weekIds, mondayDate, sundayDate } = getWeekInfo();

      if (scoreboardWeekLabel) {
        const fmt = (d) =>
          d.getUTCDate().toString().padStart(2,"0") + "/" +
          (d.getUTCMonth()+1).toString().padStart(2,"0");
        scoreboardWeekLabel.textContent = `${fmt(mondayDate)} – ${fmt(sundayDate)}`;
      }

      scoreboardContent.textContent = "Loading scoreboard...";
      scoreboardContent.className = "scoreboard-content score-empty";

      const { data, error } = await supabase
        .from("vpwordle_results")
        .select("user_id, user_email, puzzle_id, guesses_used, won")
        .in("puzzle_id", weekIds)
        .order("user_email", { ascending: true });

      if (error) {
        console.error("Scoreboard error:", error);
        scoreboardContent.textContent = "Could not load scoreboard.";
        return;
      }

      if (!data || !data.length) {
        scoreboardContent.textContent = "No games played this week yet.";
        return;
      }

      const byUser = {};
      data.forEach(row => {
        const email = row.user_email || row.user_id || "Unknown";
        if (!byUser[email]) {
          byUser[email] = {
            email,
            scores: Array(7).fill(null)
          };
        }
        const dayIndex = weekIds.indexOf(row.puzzle_id);
        if (dayIndex === -1) return;

        const val = row.won ? row.guesses_used : "X";
        const existing = byUser[email].scores[dayIndex];

        if (existing == null) {
          byUser[email].scores[dayIndex] = val;
        } else if (typeof val === "number" && (typeof existing !== "number" || val < existing)) {
          byUser[email].scores[dayIndex] = val;
        }
      });

      const users = Object.values(byUser);
      if (!users.length) {
        scoreboardContent.textContent = "No games played this week yet.";
        return;
      }

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");

      const thName = document.createElement("th");
      thName.textContent = "Player";
      headerRow.appendChild(thName);

      WEEKDAY_LABELS.forEach(label => {
        const th = document.createElement("th");
        th.textContent = label;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      users.forEach(u => {
        const tr = document.createElement("tr");
        const nameCell = document.createElement("td");
        nameCell.textContent = u.email;
        tr.appendChild(nameCell);

        u.scores.forEach(val => {
          const td = document.createElement("td");
          if (val == null) {
            td.textContent = "-";
            td.style.opacity = "0.5";
          } else {
            td.textContent = val;
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      scoreboardContent.className = "scoreboard-content";
      scoreboardContent.innerHTML = "";
      scoreboardContent.appendChild(table);
    }

    async function saveResultToSupabase({ puzzleId, guessesUsed, won }){
      if(!supabase) return;
      const { data:{ user } } = await supabase.auth.getUser();
      if(!user) return;

      await supabase.from("vpwordle_results").upsert({
        user_id: user.id,
        user_email: user.email,
        puzzle_id: puzzleId,
        guesses_used: guessesUsed,
        won
      });

      await loadScoreboard();
    }

    // -------------------- PRIVATE GAME DATA --------------------
    let solutions = [];
    let validGuesses = new Set();
    let _answer = "";           // private in closure
    const setAnswer = (w) => { _answer = w; };

    const boardEl = document.getElementById("board");
    const keyboardEl = document.getElementById("keyboard");

    let currentRow = 0;
    let currentCol = 0;
    let isGameOver = false;
    const guesses = Array.from({length:6}, ()=>Array(5).fill(""));
    const keyState = {}; // unknown | grey | yellow | green

    // -------------------- WORD LISTS --------------------
    async function loadWordLists(){
      try{
        const base = window.location.href;
        const solURL = new URL("solutions.txt", base);
        const guessURL = new URL("guesses.txt", base);
        solURL.searchParams.set("v", Date.now());
        guessURL.searchParams.set("v", Date.now());

        const [solRes, guessRes] = await Promise.all([
          fetch(solURL, {cache:"no-store"}),
          fetch(guessURL, {cache:"no-store"})
        ]);

        if(!solRes.ok) throw new Error("solutions.txt HTTP " + solRes.status);
        if(!guessRes.ok) throw new Error("guesses.txt HTTP " + guessRes.status);

        const solText = await solRes.text();
        const guessText = await guessRes.text();

        solutions = solText.split(/\r?\n/).map(w=>w.trim().toLowerCase()).filter(w=>w.length===5);
        const guessesArr = guessText.split(/\r?\n/).map(w=>w.trim().toLowerCase()).filter(w=>w.length===5);

        validGuesses = new Set([...solutions, ...guessesArr]);

        if(!solutions.length || !validGuesses.size){
          throw new Error("Word lists loaded empty.");
        }
      } catch(err){
        console.error("Word list load failed:", err);
        solutions = ["crane","plane","stare","trace","slate","charm","flint","pride","sugar","storm"];
        validGuesses = new Set(solutions);
        setStatus("Could not load word lists, using fallback list.", true);
      }
    }

    function pickAnswer(){
      const idx = getDailyIndex() % solutions.length;
      setAnswer(solutions[idx]);
    }

    // -------------------- LOCAL SAVE / RESTORE --------------------
    function saveState(){
      localStorage.setItem("vpwordle_state", JSON.stringify({
        puzzleId:getPuzzleId(), guesses, currentRow, currentCol, isGameOver, keyState
      }));
    }

    function loadState(){
      const raw = localStorage.getItem("vpwordle_state");
      if(!raw) return false;
      try{
        const state = JSON.parse(raw);
        if(state.puzzleId !== getPuzzleId()){
          localStorage.removeItem("vpwordle_state");
          return false;
        }
        for(let r=0;r<6;r++){
          for(let c=0;c<5;c++){
            guesses[r][c] = state.guesses?.[r]?.[c] || "";
          }
        }
        currentRow = state.currentRow || 0;
        currentCol = state.currentCol || 0;
        isGameOver = !!state.isGameOver;
        for(const k in keyState) delete keyState[k];
        Object.assign(keyState, state.keyState || {});
        return true;
      } catch {
        return false;
      }
    }

    // -------------------- UI BUILD --------------------
    function buildBoard(){
      if (!boardEl) return;
      boardEl.innerHTML = "";
      for(let r=0;r<6;r++){
        const row = document.createElement("div");
        row.className = "row";
        for(let c=0;c<5;c++){
          const tile = document.createElement("div");
          tile.className = "tile";
          tile.id = `tile-${r}-${c}`;
          row.appendChild(tile);
        }
        boardEl.appendChild(row);
      }
    }

    const KEY_LAYOUT = [
      ["q","w","e","r","t","y","u","i","o","p"],
      ["a","s","d","f","g","h","j","k","l"],
      ["enter","z","x","c","v","b","n","m","backspace"]
    ];

    function buildKeyboard(){
      if (!keyboardEl) return;
      keyboardEl.innerHTML = "";
      KEY_LAYOUT.forEach(rowKeys=>{
        const row = document.createElement("div");
        row.className = "keyrow";
        rowKeys.forEach(k=>{
          const btn = document.createElement("button");
          btn.className = "key";
          btn.dataset.key = k;
          btn.textContent = (k==="backspace") ? "⌫" : k;
          if(k==="enter"||k==="backspace") btn.classList.add("wide");
          btn.onclick = () => handleKey(k);
          row.appendChild(btn);
        });
        keyboardEl.appendChild(row);
      });
    }

    function updateTile(r,c,letter){
      const tile = document.getElementById(`tile-${r}-${c}`);
      if(!tile) return;
      tile.textContent = letter;
      if(letter){
        tile.classList.add("pop");
        setTimeout(()=>tile.classList.remove("pop"), 90);
      }
    }

    function paintRow(r,colours){
      for(let c=0;c<5;c++){
        const tile = document.getElementById(`tile-${r}-${c}`);
        if(tile) tile.classList.add(colours[c]);
      }
    }

    function upgradeKeyState(letter,newState){
      const rank={unknown:0,grey:1,yellow:2,green:3};
      const old=keyState[letter]||"unknown";
      if(rank[newState]>rank[old]) keyState[letter]=newState;
    }

    function repaintKeyboard(){
      document.querySelectorAll("button.key").forEach(btn=>{
        const k=btn.dataset.key;
        btn.classList.remove("green","yellow","grey","disabled");
        if(k.length===1){
          const st=keyState[k]||"unknown";
          if(st!=="unknown") btn.classList.add(st);
          if(st==="grey") btn.classList.add("disabled");
        }
      });
    }

    // -------------------- SCORING --------------------
    function scoreGuess(guess){
      const answer=_answer;
      const result=Array(5).fill("grey");
      const a=answer.split("");
      const g=guess.split("");

      for(let i=0;i<5;i++){
        if(g[i]===a[i]){
          result[i]="green";
          a[i]=null; g[i]=null;
        }
      }
      for(let i=0;i<5;i++){
        if(g[i] && a.includes(g[i])){
          result[i]="yellow";
          a[a.indexOf(g[i])]=null;
        }
      }
      return result;
    }

    // -------------------- INPUT --------------------
    function handleKey(key){
      if(isGameOver) return;

      if(key==="enter"){
        const guess=guesses[currentRow].join("");
        if(guess.length<5) return setStatus("Not enough letters.");
        if(!validGuesses.has(guess)) return setStatus("Not in word list.");

        const colours=scoreGuess(guess);
        paintRow(currentRow,colours);

        for(let i=0;i<5;i++) upgradeKeyState(guess[i], colours[i]);
        repaintKeyboard();
        saveState();

        if(guess===_answer){
          isGameOver=true; saveState();
          saveResultToSupabase({ puzzleId:getPuzzleId(), guessesUsed:currentRow+1, won:true });
          return setStatus(`You got it. The word was ${_answer.toUpperCase()}.`, true);
        }

        currentRow++; currentCol=0;

        if(currentRow===6){
          isGameOver=true; saveState();
          saveResultToSupabase({ puzzleId:getPuzzleId(), guessesUsed:6, won:false });
          return setStatus(`Out of guesses. The word was ${_answer.toUpperCase()}.`, true);
        }

        setStatus("");
        return;
      }

      if(key==="backspace"){
        if(currentCol>0){
          currentCol--;
          guesses[currentRow][currentCol]="";
          updateTile(currentRow,currentCol,"");
          saveState();
        }
        return;
      }

      if(/^[a-z]$/.test(key)){
        if(currentCol<5){
          guesses[currentRow][currentCol]=key;
          updateTile(currentRow,currentCol,key);
          currentCol++;
          saveState();
        }
      }
    }

    window.addEventListener("keydown",(e)=>{
      if(typeof e.key!=="string") return;
      const k=e.key.toLowerCase();
      if(k==="enter"||k==="backspace"||/^[a-z]$/.test(k)) handleKey(k);
    });

    // -------------------- STARTUP --------------------
    async function startGame(){
      setStatus("Loading word lists...");
      await loadWordLists();

      pickAnswer();
      buildBoard();
      buildKeyboard();

      const restored=loadState();

      if(restored){
        for(let r=0;r<6;r++){
          const guessStr=guesses[r].join("");
          if(!guessStr) continue;

          for(let c=0;c<5;c++) updateTile(r,c,guesses[r][c]);

          if(r<currentRow){
            const colours=scoreGuess(guessStr);
            paintRow(r,colours);
          }
        }
        repaintKeyboard();

        if(isGameOver){
          const lastGuess=guesses[currentRow-1]?.join("")||"";
          if(lastGuess===_answer){
            setStatus(`You got it. The word was ${_answer.toUpperCase()}.`, true);
          } else {
            setStatus(`Out of guesses. The word was ${_answer.toUpperCase()}.`, true);
          }
        } else {
          setStatus("");
        }
      } else {
        guesses.forEach(r=>r.fill(""));
        currentRow=0; currentCol=0; isGameOver=false;
        for(const k in keyState) delete keyState[k];
        saveState();
        setStatus("");
      }
    }

    window.addEventListener("DOMContentLoaded", async () => {
      try{
        await refreshAuthUI();
        await startGame();
        if (supabase) {
          await loadScoreboard();
        }
      } catch(e){
        console.error("Boot error:", e);
      } finally {
        hideLoader();
      }
    });

  })();
  </script>
</body>
</html>
